---
definitions:
  non_empty_string:
    type: string
    minLength: 1
  uuid:
    type: string
    pattern: "^[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}$"
  relay_id:
    type: string
    pattern: ^\S+$
  device_id:
    type: string
    pattern: ^\S+$
  device_asset_tag:
    type: string
    pattern: ^\S+$
  ipaddr:
    anyOf:
      - type: string
        format: ipv4
      - type: string
        format: ipv6
  macaddr:
    type: string
    pattern: "^[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}:[0-9A-Fa-f]{2}$"
  int_or_stringy_int:
    description: an integer that may be presented as a json string
    anyOf:
      - type: integer
      - type: string
        pattern: "^[0-9]+$"
  DatacenterCreate:
    type: object
    additionalProperties: false
    required:
      - vendor
      - region
      - location
    properties:
      vendor:
        type: string
      region:
        type: string
      vendor_name:
        type: string
      location:
        type: string
  DatacenterUpdate:
    type: object
    additionalProperties: false
    properties:
      vendor:
        type: string
      region:
        type: string
      vendor_name:
        type: string
      location:
        type: string
  DatacenterRoomCreate:
    type: object
    additionalProperties: false
    required:
      - datacenter
      - az
    properties:
      datacenter:
        $ref: /definitions/uuid
      az:
        type: string
      alias:
        type: string
      vendor_name:
        type: string
  DatacenterRoomUpdate:
    type: object
    additionalProperties: false
    properties:
      datacenter:
        $ref: /definitions/uuid
      az:
        type: string
      alias:
        type: string
      vendor_name:
        type: string

  DeviceReport:
    type: object
    required:
      - bios_version
      - product_name
      - serial_number
      - state
      - system_uuid
    properties:
      bios_version:
        type: string
      cpus:
        type: array
        items:
          type: object
      dimms:
        type: array
        uniqueItems: true
        items:
          type: object
          required:
            - memory-locator
          properties:
            memory-locator:
              type: string
            memory-serial-number:
              type: string
            memory-size:
              $ref: /definitions/int_or_stringy_int
      disks:
        type: object
        patternProperties:
          ^\S+$:
            description: device_disk.serial_number
            type: object
            properties:
              slot:
                $ref: /definitions/int_or_stringy_int
              size:
                type: integer
              vendor:
                type: string
              model:
                type: string
              firmware:
                type: string
              transport:
                type: string
              health:
                type: string  # TODO: enum?
              drive_type:
                type: string
              temp:
                $ref: /definitions/int_or_stringy_int
              enclosure:
                type: string
              hba:
                type: string
              # any additional fields are not currently used.
      device_type:
        type: string
        enum:
          - server
          - switch
      interfaces:
        # TODO: this is required for servers
        type: object
        patternProperties:
          ^\S+$:
            description: interface name
            type: object
            required:
              - mac
              - product
              - vendor
            properties:
              mac:
                $ref: /definitions/macaddr
              product:
                type: string
              vendor:
                type: string
              state:
                anyOf:
                  - type: string
                  - type: 'null'
              # note: no speed yet?
              ipaddr:
                anyOf:
                  - $ref: /definitions/ipaddr
                  - type: 'null'
              mtu:
                anyOf:
                  - $ref: /definitions/int_or_stringy_int
                  - type: 'null'
              peer_mac:
                anyOf:
                  - $ref: /definitions/macaddr
                  - type: 'null'
              # peer_text, peer_switch, peer_port, all optional with no constraints
      media:
        # TODO: this is required for switches
        type: object
        patternProperties:
          ^\S$:
            description: port
            # type: unknown and not used.
      os:
        type: object
        required:
          - hostname
        properties:
          hostname:
            type: string
      product_name:
        # TODO: required for switches, and also for non-switches when 'sku' is not present.
        type: string
      relay:
        type: object
        required:
          - serial
        properties:
          serial:
            type: string
      serial_number:
        $ref: /definitions/device_id
      state:
        type: string
      system_uuid:
        $ref: /definitions/uuid
      temp:
        type: object
        required:
          - cpu0
          - cpu1
        properties:
          cpu0:
            $ref: /definitions/int_or_stringy_int
          cpu1:
            $ref: /definitions/int_or_stringy_int
          exhaust:
            $ref: /definitions/int_or_stringy_int
          inlet:
            $ref: /definitions/int_or_stringy_int
      uptime_since:
        type: string
  RackCreate:
    type: object
    additionalProperties: false
    required:
      - name
      - datacenter_room_id
      - role
    properties:
      name:
        type: string
      datacenter_room_id:
        $ref: /definitions/uuid
      role:
        $ref: /definitions/uuid
  RackUpdate:
    type: object
    additionalProperties: false
    properties:
      name:
        type: string
      datacenter_room_id:
        $ref: /definitions/uuid
      role:
        $ref: /definitions/uuid
      serial_number:
        type: string
      asset_tag:
        type: string
  RackAssignmentUpdates:
    type: array
    uniqueItems: true
    items:
      $ref: /definitions/RackAssignmentUpdate
  RackAssignmentUpdate:
    type: object
    additionalProperties: false
    required:
      - device_id
      - rack_unit_start
    properties:
      device_id:
        $ref: /definitions/device_id
      rack_unit_start:
        type: integer
        description: Starting RU slot position
      device_asset_tag:
        oneOf:
          - $ref: /definitions/device_asset_tag
          - type: 'null'
  RackAssignmentDeletes:
    type: array
    uniqueItems: true
    items:
      $ref: /definitions/RackAssignmentDelete
  RackAssignmentDelete:
    type: object
    additionalProperties: false
    required:
      - device_id
      - rack_unit_start
    properties:
      device_id:
        $ref: /definitions/device_id
      rack_unit_start:
        type: integer
        description: Starting RU slot position
  RackRoleCreate:
    type: object
    additionalProperties: false
    required:
      - name
      - rack_size
    properties:
      name:
        type: string
      rack_size:
        type: integer
  RackRoleUpdate:
    type: object
    additionalProperties: false
    properties:
      name:
        type: string
      rack_size:
        type: integer
  RackLayoutCreate:
    type: object
    additionalProperties: false
    required:
      - rack_id
      - product_id
      - ru_start
    properties:
      rack_id:    # TODO: this really should be datacenter_rack_id
        $ref: /definitions/uuid
      product_id: # TODO: this really should be hardware_product_id
        $ref: /definitions/uuid
      ru_start: # TODO: this really should be rack_unit_start
        type: integer
  RackLayoutUpdate:
    type: object
    additionalProperties: false
    properties:
      # this field is deprecated: cannot change rack_id in an existing layout
      rack_id:    # TODO: this really should be datacenter_rack_id
        $ref: /definitions/uuid
      product_id: # TODO: this really should be hardware_product_id
        $ref: /definitions/uuid
      ru_start: # TODO: this really should be rack_unit_start
        type: integer
  WorkspaceRackLayoutUpdate:
    type: object
    additionalProperties: false
    minProperties: 1
    patternProperties:
      ^[\w-]+$:         # device id
        description: rack_unit_start
        type: integer
  DeviceLocationUpdate:
    type: object
    additionalProperties: false
    required:
      - rack_id
      - rack_unit
    properties:
      rack_id:
        $ref: /definitions/uuid
      rack_unit:
        type: integer
  HardwareProductCreate:
    type: object
    additionalProperties: false
    required:
      - name
      - alias
    oneOf:
      - required:
        - hardware_vendor_id
      # old name maintained for backcompat for now. please switch to the full name.
      - required:
        - vendor
    properties:
      name:
        type: string
      alias:
        type: string
      prefix:
        anyOf:
          - type: string
          - type: 'null'
      vendor:
        $ref: /definitions/uuid
      hardware_vendor_id:
        $ref: /definitions/uuid
      specification:
        description: json blob of additional data
        anyOf:
          - type: string
          - type: 'null'
      sku:              # nullable in the db, but required for new entries
        type: string
      generation_name:  # nullable in the db, but required for new entries
        type: string
      legacy_product_name:
        anyOf:
          - type: string
          - type: 'null'
      hardware_product_profile:
        $ref: /definitions/HardwareProductProfileCreate
  HardwareProductProfileUpdate:
    type: object
    additionalProperties: false
    properties:
      rack_unit:
        type: integer
      purpose:
        type: string
      bios_firmware:
        type: string
      hba_firmware:
        anyOf:
          - type: string
          - type: 'null'
      cpu_num:
        type: integer
      cpu_type:
        type: string
      dimms_num:
        type: integer
      ram_total:
        type: integer
      nics_num:
        type: integer
      sata_hdd_num:
        anyOf:
          - type: integer
          - type: 'null'
      sata_hdd_size:
        anyOf:
          - type: integer
          - type: 'null'
      sata_hdd_slots:
        anyOf:
          - type: string
          - type: 'null'
      sas_hdd_num:
        anyOf:
          - type: integer
          - type: 'null'
      sas_hdd_size:
        anyOf:
          - type: integer
          - type: 'null'
      sas_hdd_slots:
        anyOf:
          - type: string
          - type: 'null'
      sata_ssd_num:
        anyOf:
          - type: integer
          - type: 'null'
      sata_ssd_size:
        anyOf:
          - type: integer
          - type: 'null'
      sata_ssd_slots:
        anyOf:
          - type: string
          - type: 'null'
      sas_ssd_num:
        anyOf:
          - type: integer
          - type: 'null'
      sas_ssd_size:
        anyOf:
          - type: integer
          - type: 'null'
      sas_ssd_slots:
        anyOf:
          - type: string
          - type: 'null'
      nvme_ssd_num:
        anyOf:
          - type: integer
          - type: 'null'
      nvme_ssd_size:
        anyOf:
          - type: integer
          - type: 'null'
      nvme_ssd_slots:
        anyOf:
          - type: string
          - type: 'null'
      raid_lun_num:
        anyOf:
          - type: integer
          - type: 'null'
      psu_total:
        anyOf:
          - type: integer
          - type: 'null'
      usb_num:
        type: integer
  HardwareProductUpdate:
    type: object
    additionalProperties: false
    not:
      required:
        # cannot have hardware_vendor_id *and* vendor together.
        - hardware_vendor_id
        - vendor
    properties:
      name:
        type: string
      alias:
        type: string
      prefix:
        anyOf:
          - type: string
          - type: 'null'
      hardware_vendor_id:
        $ref: /definitions/uuid
      vendor:
        description: for backcompat only.
        $ref: /definitions/uuid
      specification:
        description: json blob of additional data
        anyOf:
          - type: string
          - type: 'null'
      sku:
        type: string
      generation_name:
        type: string
      legacy_product_name:
        anyOf:
          - type: string
          - type: 'null'
      hardware_product_profile:
        $ref: /definitions/HardwareProductProfileUpdate
  HardwareProductProfileCreate:
    allOf:
      - $ref: /definitions/HardwareProductProfileUpdate
      - required:
        - rack_unit
        - purpose
        - bios_firmware
        - cpu_num
        - cpu_type
        - dimms_num
        - ram_total
        - nics_num
        - usb_num
  Login:
    type: object
    additionalProperties: false
    required:
      - user
      - password
    properties:
      user:
        description: either a uuid, or email=<email address>
        $ref: /definitions/non_empty_string
      password:
        $ref: /definitions/non_empty_string
  UserPassword:
    type: object
    additionalProperties: false
    required:
      - password
    properties:
      password:
        type: string
  NewUser:
    type: object
    additionalProperties: false
    required:
      - email
    properties:
      name:
        type: string
      email:
        type: string
        format: email
      password:
        type: string
      is_admin:
        type: boolean
  UpdateUser:
    type: object
    additionalProperties: false
    properties:
      name:
        type: string
      email:
        type: string
        format: email
      is_admin:
        type: boolean
  CreateValidationPlan:
    type: object
    additionalProperties: false
    required:
      - name
      - description
    properties:
      name:
        type: string
      description:
        type: string
  AddValidationToPlan:
    type: object
    additionalProperties: false
    required:
      - id
    properties:
      id:
        $ref: /definitions/uuid
  WorkspaceAddRack:
    type: object
    additionalProperties: false
    required:
      - id
    properties:
      id:
        $ref: /definitions/uuid
      serial_number:
        type: string
      asset_tag:
        type: string
  WorkspaceCreate:
    type: object
    additionalProperties: false
    required:
      - name
    properties:
      name:
        $ref: /definitions/non_empty_string
      description:
        anyOf:
          - type: 'null'
          - $ref: /definitions/non_empty_string
  WorkspaceAddUser:
    type: object
    additionalProperties: false
    required:
      - user
      - role
    properties:
      user:
        type: string
        format: email
      role:
        type: string
        enum:
          - ro
          - rw
          - admin
  DeviceAssetTag:
    type: object
    additionalProperties: false
    required:
      - asset_tag
    properties:
      asset_tag:
        $ref: /definitions/device_asset_tag
  DeviceTritonUuid:
    type: object
    additionalProperties: false
    required:
      - triton_uuid
    properties:
      triton_uuid:
        $ref: /definitions/uuid
  WorkspaceRoomReplace:
    type: array
    uniqueItems: true
    items:
      description: datacenter room ids
      $ref: /definitions/uuid
  RegisterRelay:
    type: object
    additionaProperties: false
    required:
      - serial
    properties:
      serial:
        $ref: /definitions/relay_id
      alias:
        type: string
      version:
        description: usually a git commit SHA
        type: string
      ipaddr:
        description: 'postgres "inet": ipv4 or ipv6, with optional netmask'
        type: string
      ssh_port:
        type: integer

# vim: set sts=2 sw=2 et :
